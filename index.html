<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <title>Beatstar</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon-192.png">
  
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      user-select: none;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
      overscroll-behavior: none;
      position: fixed;
      width: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }
    
    #root {
      width: 100%;
      height: 100%;
      overflow: auto;
    }

    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .game-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-size: 400% 400%;
      animation: gradientShift 10s ease infinite;
    }

    @keyframes laneFlash {
      0% { background-color: rgba(76, 175, 80, 0.5); }
      100% { background-color: transparent; }
    }

    .lane-flash {
      animation: laneFlash 0.3s ease-out;
    }

    @keyframes judgmentPop {
      0% { transform: scale(0); opacity: 0; }
      30% { transform: scale(1.3); opacity: 1; }
      100% { transform: scale(1); opacity: 0; }
    }

    .judgment-text {
      animation: judgmentPop 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .waveform {
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255,255,255,0.3) 10%,
        rgba(255,255,255,0.6) 20%,
        rgba(255,255,255,0.3) 30%,
        transparent 40%,
        transparent 60%,
        rgba(255,255,255,0.3) 70%,
        rgba(255,255,255,0.6) 80%,
        rgba(255,255,255,0.3) 90%,
        transparent 100%
      );
      background-size: 200% 100%;
      animation: waveMove 2s linear infinite;
    }

    @keyframes waveMove {
      0% { background-position: 0% 0%; }
      100% { background-position: 200% 0%; }
    }
  </style>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            beatstar: {
              dark: '#0a0e27',
              purple: '#6366f1',
              pink: '#ec4899'
            }
          }
        }
      }
    }
  </script>
</head>
<body>
  <div id="root"></div>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./songs.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    
    // Icons
    const Star = ({className = "w-5 h-5", filled = false}) => (
      <svg className={className} fill={filled ? "currentColor" : "none"} stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
      </svg>
    );
    
    const Lock = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>;
    const Music = () => <svg className="w-full h-full" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" /></svg>;
    const Heart = ({filled}) => <svg className="w-6 h-6" fill={filled ? "currentColor" : "none"} stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>;
    const Plus = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>;
    const Fire = () => <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 23C7.04 23 3 19.09 3 14.25 3 9.79 5.88 6.95 9 4.18c.37-.32.97-.06.97.43v.03c0 .42-.23.81-.61 1.03-2.03 1.09-3.1 3.48-2.5 5.98.54 2.26 2.41 4.09 4.68 4.58 3.89.83 7.26-1.65 7.46-5.44.01-.21.01-.42.01-.63 0-.73-.12-1.43-.34-2.09-.09-.27.18-.54.44-.45C20.73 8.5 21 10.86 21 14.25 21 19.09 16.96 23 12 23z"/></svg>;

    // GAME CONSTANTS - FIXED
    const LANES = 3;
    const HIT_PANEL_START = 0.78;
    const HIT_PANEL_END = 0.92;
    const HIT_LINE = 0.85; // Middle of panel
    const NOTE_SPEED = 0.00048; // Slower for better sync
    const NOTE_WIDTH_RATIO = 0.92; // Notes take 92% of lane width
    const NOTE_HEIGHT = 100; // Slightly taller
    const TIMING_WINDOWS = { perfect: 70, great: 110, good: 160, miss: 210 };
    const NOTE_TYPES = { TAP: 'tap', HOLD: 'hold', SWIPE_LEFT: 'left', SWIPE_RIGHT: 'right', SWIPE_UP: 'up' };

    const INITIAL_PLAYER = {
      id: 'player1',
      name: 'Player',
      currency: 0,
      totalStars: 0,
      unlockedSongs: ['no-me-pidas-perdon', 'levels', 'feel-u-luv-me'], // 3 starters
      completedChallenges: [],
      scores: {},
      wishlist: [],
      unlockedGiftBoxes: []
    };

    // Load songs from JSON files
    const loadSongs = async () => {
      const songList = window.SONG_LIST || ['no-me-pidas-perdon', 'levels', 'feel-u-luv-me', 'bad-romance', 'fireflies'];
      const songs = [];
      
      for (const songId of songList) {
        try {
          const response = await fetch(`./songs/${songId}.json`);
          const metadata = await response.json();
          songs.push({
            ...metadata,
            audioUrl: `./songs/${songId}.mp3`,
            coverUrl: `./songs/${songId}.jpg` // Optional
          });
        } catch (e) {
          console.warn(`Could not load ${songId}:`, e);
        }
      }
      
      return songs.length > 0 ? songs : [];
    };

    // Enhanced beatmap generation - more variety
    const generateBeatmap = (bpm, duration, difficulty) => {
      const notes = [];
      const beatInterval = (60 / bpm) * 1000;
      
      // Difficulty affects density AND variety
      const config = {
        easy: { density: 0.45, holds: 0.05, swipes: 0.10, doubles: 0.05 },
        normal: { density: 0.65, holds: 0.12, swipes: 0.18, doubles: 0.10 },
        hard: { density: 0.90, holds: 0.15, swipes: 0.25, doubles: 0.15 }
      }[difficulty] || { density: 0.65, holds: 0.12, swipes: 0.18, doubles: 0.10 };
      
      let time = 3000;
      const endTime = duration * 1000 - 3000;
      let lastLanes = [];

      while (time < endTime) {
        const onBeat = Math.round(time / beatInterval) * beatInterval;
        time = onBeat;

        const roll = Math.random();
        
        // Chance of double notes (two lanes at once)
        if (roll < config.doubles && difficulty !== 'easy') {
          const lanes = [0, 1, 2].sort(() => Math.random() - 0.5).slice(0, 2);
          lanes.forEach(lane => {
            notes.push({
              id: `note-${time}-${lane}`,
              lane,
              time,
              type: NOTE_TYPES.TAP,
              duration: 0
            });
          });
          lastLanes = lanes;
        } else {
          // Single note
          let lane = Math.floor(Math.random() * LANES);
          while (lastLanes.includes(lane) && lastLanes.length > 0) {
            lane = Math.floor(Math.random() * LANES);
          }
          lastLanes = [lane];

          const typeRoll = Math.random();
          let noteType = NOTE_TYPES.TAP;
          
          if (typeRoll < config.holds) {
            noteType = NOTE_TYPES.HOLD;
          } else if (typeRoll < config.holds + config.swipes) {
            const swipes = [NOTE_TYPES.SWIPE_UP, NOTE_TYPES.SWIPE_LEFT, NOTE_TYPES.SWIPE_RIGHT];
            noteType = swipes[Math.floor(Math.random() * swipes.length)];
          }

          notes.push({
            id: `note-${time}-${lane}`,
            lane,
            time,
            type: noteType,
            duration: noteType === NOTE_TYPES.HOLD ? beatInterval * 2 : 0
          });
        }
        
        time += beatInterval / config.density;
      }
      
      return notes;
    };

    const calculateStars = (accuracy) => {
      if (accuracy >= 98) return 5;
      if (accuracy >= 95) return 4;
      if (accuracy >= 90) return 3;
      if (accuracy >= 80) return 2;
      if (accuracy >= 60) return 1;
      return 0;
    };

    const calculateCurrency = (stars, difficulty) => {
      const baseReward = { easy: 5, normal: 10, hard: 20 }[difficulty] || 10;
      return baseReward * stars;
    };

    function BeatstarClone() {
      const [loading, setLoading] = useState(true);
      const [currentScreen, setCurrentScreen] = useState('home');
      const [player, setPlayer] = useState(() => {
        try {
          const saved = localStorage.getItem('beatstar-player');
          return saved ? JSON.parse(saved) : INITIAL_PLAYER;
        } catch (e) {
          return INITIAL_PLAYER;
        }
      });
      const [songs, setSongs] = useState([]);
      const [selectedSong, setSelectedSong] = useState(null);
      const [selectedDifficulty, setSelectedDifficulty] = useState('normal');

      useEffect(() => {
        loadSongs().then(loadedSongs => {
          setSongs(loadedSongs);
          setLoading(false);
        });
      }, []);

      useEffect(() => {
        try {
          localStorage.setItem('beatstar-player', JSON.stringify(player));
        } catch (e) {
          console.error('Failed to save player data:', e);
        }
      }, [player]);

      const isSongUnlocked = (song) => player.unlockedSongs.includes(song.id);
      const canUnlockSong = (song) => {
        if (isSongUnlocked(song)) return false;
        return !song.requiredStars || player.totalStars >= song.requiredStars;
      };

      const unlockSong = (songId) => {
        setPlayer(prev => ({
          ...prev,
          unlockedSongs: [...new Set([...prev.unlockedSongs, songId])]
        }));
      };

      const toggleWishlist = (songId) => {
        setPlayer(prev => ({
          ...prev,
          wishlist: prev.wishlist.includes(songId)
            ? prev.wishlist.filter(id => id !== songId)
            : [...prev.wishlist, songId]
        }));
      };

      const startGame = (song, difficulty) => {
        setSelectedSong(song);
        setSelectedDifficulty(difficulty);
        setCurrentScreen('game');
      };

      const endGame = (score, accuracy, perfect, great, good, miss) => {
        const stars = calculateStars(accuracy);
        const currencyEarned = calculateCurrency(stars, selectedDifficulty);
        const scoreKey = `${selectedSong.id}-${selectedDifficulty}`;
        const previousBest = player.scores[scoreKey];
        const isNewBest = !previousBest || score > previousBest.score;

        setPlayer(prev => {
          const newScores = { ...prev.scores };
          if (isNewBest) {
            newScores[scoreKey] = { score, stars, accuracy, perfect, great, good, miss };
          }
          const newTotalStars = Object.values(newScores).reduce((sum, s) => sum + s.stars, 0);
          return {
            ...prev,
            scores: newScores,
            totalStars: newTotalStars,
            currency: prev.currency + currencyEarned
          };
        });

        setCurrentScreen('home');
      };

      if (loading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 flex items-center justify-center">
            <div className="text-white text-2xl font-bold animate-pulse">Loading...</div>
          </div>
        );
      }

      if (currentScreen === 'game' && selectedSong) {
        return <GameScreen song={selectedSong} difficulty={selectedDifficulty} onEnd={endGame} onBack={() => setCurrentScreen('home')} />;
      }

      // HOME SCREEN - Improved UI like Beatstar
      const unlockedSongs = songs.filter(isSongUnlocked);
      const lockedSongs = songs.filter(s => !isSongUnlocked(s));
      const canUnlock = lockedSongs.filter(canUnlockSong);

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
          {/* Header */}
          <div className="sticky top-0 z-30 bg-slate-900/95 backdrop-blur-xl border-b border-white/10">
            <div className="px-6 py-4">
              <div className="flex items-center justify-between mb-3">
                <div>
                  <h1 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 tracking-tight">
                    COLLECTION
                  </h1>
                </div>
                <div className="flex gap-4">
                  <div className="flex items-center gap-2 bg-gradient-to-r from-yellow-500/20 to-orange-500/20 px-4 py-2 rounded-full border border-yellow-500/30">
                    <span className="text-2xl">üí∞</span>
                    <span className="font-bold text-yellow-300">{player.currency}</span>
                  </div>
                </div>
              </div>
              
              <div className="flex gap-6 text-sm">
                <div className="text-gray-400">{songs.length} SONGS</div>
                <div className="flex items-center gap-2">
                  <div className="flex items-center gap-1">
                    <Star className="w-4 h-4 text-purple-400" filled />
                    <span className="text-gray-300">{player.totalStars}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div className="px-6 py-6 space-y-6">
            {/* Unlocked Songs */}
            <div>
              <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <span className="text-2xl">üéµ</span>
                Your Songs
              </h2>
              
              <div className="space-y-3">
                {unlockedSongs.map(song => {
                  const scoreKey = `${song.id}-normal`;
                  const songScore = player.scores[scoreKey];
                  const inWishlist = player.wishlist.includes(song.id);

                  return (
                    <div key={song.id} className="group bg-gradient-to-r from-purple-900/40 to-pink-900/40 rounded-2xl p-4 border border-purple-500/30 hover:border-purple-400/50 transition-all hover:scale-[1.02]">
                      <div className="flex items-center gap-4">
                        {/* Album Art */}
                        <div className="w-20 h-20 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center flex-shrink-0 shadow-lg relative overflow-hidden">
                          <Music />
                          {songScore && songScore.stars > 0 && (
                            <div className="absolute bottom-1 right-1 bg-black/70 rounded-full p-1">
                              <Fire />
                            </div>
                          )}
                        </div>

                        {/* Song Info */}
                        <div className="flex-1 min-w-0">
                          <h3 className="text-lg font-bold text-white truncate">{song.title}</h3>
                          <p className="text-sm text-gray-300">{song.artist}</p>
                          <div className="flex gap-2 mt-1">
                            <span className="text-xs px-2 py-0.5 bg-purple-500/30 rounded-full text-purple-200">{song.genre}</span>
                          </div>
                        </div>

                        {/* Stars & Actions */}
                        <div className="flex items-center gap-3">
                          {songScore && (
                            <div className="flex gap-0.5">
                              {[...Array(5)].map((_, i) => (
                                <Star key={i} className="w-5 h-5" filled={i < songScore.stars} />
                              ))}
                            </div>
                          )}
                          <button
                            onClick={(e) => { e.stopPropagation(); toggleWishlist(song.id); }}
                            className="p-2 rounded-full hover:bg-white/10 transition-colors"
                          >
                            <Heart filled={inWishlist} />
                          </button>
                        </div>
                      </div>

                      {/* Difficulty Buttons */}
                      <div className="grid grid-cols-3 gap-2 mt-4">
                        {['easy', 'normal', 'hard'].map(diff => {
                          const key = `${song.id}-${diff}`;
                          const score = player.scores[key];
                          
                          return (
                            <button
                              key={diff}
                              onClick={() => startGame(song, diff)}
                              className="bg-black/40 hover:bg-black/60 rounded-xl p-3 transition-all hover:scale-105 text-left border border-white/10"
                            >
                              <div className="text-xs font-bold uppercase text-purple-300 mb-1">{diff}</div>
                              {score && (
                                <div className="flex gap-0.5">
                                  {[...Array(score.stars)].map((_, i) => (
                                    <Star key={i} className="w-3 h-3 text-yellow-400" filled />
                                  ))}
                                </div>
                              )}
                            </button>
                          );
                        })}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            {/* Locked Songs */}
            {lockedSongs.length > 0 && (
              <div>
                <div className="flex items-center gap-3 mb-4">
                  <Lock />
                  <h2 className="text-xl font-bold text-white">Locked Songs</h2>
                  {canUnlock.length > 0 && (
                    <span className="text-sm text-green-400 font-bold">({canUnlock.length} ready!)</span>
                  )}
                </div>
                
                <div className="space-y-3">
                  {lockedSongs.map(song => {
                    const canUnlockThis = canUnlockSong(song);
                    const inWishlist = player.wishlist.includes(song.id);

                    return (
                      <div key={song.id} className="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50 relative overflow-hidden">
                        <div className="flex items-center gap-4">
                          <div className="w-20 h-20 rounded-xl bg-slate-700 flex items-center justify-center flex-shrink-0 relative">
                            <Lock />
                          </div>

                          <div className="flex-1">
                            <h3 className="text-lg font-bold text-gray-400">???</h3>
                            <p className="text-sm text-gray-500">Locked</p>
                            {song.requiredStars && (
                              <div className={`text-sm mt-1 ${canUnlockThis ? 'text-green-400 font-bold' : 'text-gray-500'}`}>
                                {canUnlockThis 
                                  ? `‚úì Ready! (${song.requiredStars} ‚≠ê)`
                                  : `Requires ${song.requiredStars} ‚≠ê (${song.requiredStars - player.totalStars} more)`
                                }
                              </div>
                            )}
                          </div>

                          <div className="flex gap-2">
                            {canUnlockThis && (
                              <button
                                onClick={() => unlockSong(song.id)}
                                className="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-full font-bold transition-all hover:scale-105"
                              >
                                Unlock
                              </button>
                            )}
                            <button
                              onClick={() => toggleWishlist(song.id)}
                              className="p-2 rounded-full hover:bg-white/10"
                            >
                              <Heart filled={inWishlist} />
                            </button>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    function GameScreen({ song, difficulty, onEnd, onBack }) {
      const [gameState, setGameState] = useState('ready');
      const [score, setScore] = useState(0);
      const [combo, setCombo] = useState(0);
      const [maxCombo, setMaxCombo] = useState(0);
      const [judgments, setJudgments] = useState({ perfect: 0, great: 0, good: 0, miss: 0 });
      const [notes, setNotes] = useState([]);
      const [currentTime, setCurrentTime] = useState(0);
      const [beatmap, setBeatmap] = useState(null);
      const [touchStarts, setTouchStarts] = useState({});
      const [laneFlashes, setLaneFlashes] = useState([false, false, false]);
      const [judgmentDisplay, setJudgmentDisplay] = useState(null);
      const [activeHolds, setActiveHolds] = useState(new Set());
      const gameLoopRef = useRef(null);
      const startTimeRef = useRef(null);
      const audioRef = useRef(null);

      useEffect(() => {
        const map = generateBeatmap(song.bpm, song.duration, difficulty);
        setBeatmap(map);
        setNotes(map.map(n => ({ ...n, hit: false, missed: false })));
      }, [song, difficulty]);

      const startGame = () => {
        setGameState('playing');
        startTimeRef.current = Date.now();
        
        if (song.audioUrl) {
          audioRef.current = new Audio(song.audioUrl);
          audioRef.current.play().catch(e => console.log('Audio play failed:', e));
        }
        
        gameLoopRef.current = setInterval(() => {
          const elapsed = Date.now() - startTimeRef.current;
          setCurrentTime(elapsed);

          setNotes(prev => prev.map(note => {
            if (!note.hit && !note.missed && elapsed > note.time + TIMING_WINDOWS.miss) {
              setCombo(0);
              setJudgments(j => ({ ...j, miss: j.miss + 1 }));
              showJudgment('MISS', 'text-red-500');
              return { ...note, missed: true };
            }
            return note;
          }));

          if (elapsed > song.duration * 1000) endGameNow();
        }, 16);
      };

      const endGameNow = () => {
        clearInterval(gameLoopRef.current);
        if (audioRef.current) {
          audioRef.current.pause();
          audioRef.current.currentTime = 0;
          audioRef.current = null;
        }
        setGameState('finished');
        
        const totalNotes = beatmap.length;
        const hitNotes = judgments.perfect + judgments.great + judgments.good;
        const accuracy = totalNotes > 0 ? (hitNotes / totalNotes) * 100 : 0;
        
        setTimeout(() => {
          onEnd(score, accuracy, judgments.perfect, judgments.great, judgments.good, judgments.miss);
        }, 2500);
      };

      const flashLane = (lane) => {
        setLaneFlashes(prev => {
          const n = [...prev];
          n[lane] = true;
          return n;
        });
        setTimeout(() => {
          setLaneFlashes(prev => {
            const n = [...prev];
            n[lane] = false;
            return n;
          });
        }, 300);
      };

      const showJudgment = (text, color) => {
        setJudgmentDisplay({ text, color });
        setTimeout(() => setJudgmentDisplay(null), 800);
      };

      const handleTouchStart = (e, lane) => {
        e.preventDefault();
        const touch = e.touches[0];
        const newStarts = { ...touchStarts };
        newStarts[lane] = { x: touch.clientX, y: touch.clientY, time: Date.now() };
        setTouchStarts(newStarts);
        checkHit(lane, null);
      };

      const handleTouchEnd = (e, lane) => {
        e.preventDefault();
        const start = touchStarts[lane];
        if (!start) return;

        const touch = e.changedTouches[0];
        const dx = touch.clientX - start.x;
        const dy = touch.clientY - start.y;
        const distance = Math.sqrt(dx * dx + dy * dy);

        if (distance > 60) {
          const angle = Math.atan2(dy, dx) * (180 / Math.PI);
          let swipeType = null;
          
          if (angle > -45 && angle < 45) swipeType = NOTE_TYPES.SWIPE_RIGHT;
          else if (angle < -45 && angle > -135) swipeType = NOTE_TYPES.SWIPE_UP;
          else swipeType = NOTE_TYPES.SWIPE_LEFT;
          
          if (swipeType) checkHit(lane, swipeType);
        }

        const newStarts = { ...touchStarts };
        delete newStarts[lane];
        setTouchStarts(newStarts);
      };

      const checkHit = (lane, swipeType) => {
        const hitTime = currentTime;
        let bestNote = null;
        let bestTiming = Infinity;

        notes.forEach(note => {
          if (note.lane === lane && !note.hit && !note.missed) {
            const timing = Math.abs(note.time - hitTime);
            
            if (timing < TIMING_WINDOWS.miss && timing < bestTiming) {
              // Type checking
              if (swipeType && note.type !== swipeType && note.type !== NOTE_TYPES.TAP) return;
              if (!swipeType && note.type !== NOTE_TYPES.TAP && note.type !== NOTE_TYPES.HOLD) return;
              
              bestNote = note;
              bestTiming = timing;
            }
          }
        });

        if (bestNote) {
          let judgment = 'miss', points = 0, text = 'MISS', color = 'text-red-500';
          
          if (bestTiming < TIMING_WINDOWS.perfect) {
            judgment = 'perfect';
            points = 100;
            text = 'PERFECT';
            color = 'text-green-400';
          } else if (bestTiming < TIMING_WINDOWS.great) {
            judgment = 'great';
            points = 75;
            text = 'GREAT';
            color = 'text-cyan-400';
          } else if (bestTiming < TIMING_WINDOWS.good) {
            judgment = 'good';
            points = 50;
            text = 'GOOD';
            color = 'text-yellow-400';
          }

          if (judgment !== 'miss') {
            setNotes(prev => prev.map(n => n.id === bestNote.id ? { ...n, hit: true } : n));
            setScore(s => s + points * Math.max(1, combo));
            setCombo(c => {
              const newCombo = c + 1;
              setMaxCombo(max => Math.max(max, newCombo));
              return newCombo;
            });
            setJudgments(j => ({ ...j, [judgment]: j[judgment] + 1 }));
            flashLane(lane);
            showJudgment(text, color);

            if (bestNote.type === NOTE_TYPES.HOLD) {
              setActiveHolds(prev => new Set([...prev, bestNote.id]));
            }
          } else {
            setCombo(0);
            showJudgment(text, color);
          }
        }
      };

      if (gameState === 'ready') {
        return (
          <div className="game-bg min-h-screen flex items-center justify-center text-white">
            <div className="text-center px-6">
              <div className="mb-8">
                <div className="w-32 h-32 mx-auto rounded-2xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center shadow-2xl mb-6">
                  <Music />
                </div>
                <h1 className="text-4xl font-black mb-2 drop-shadow-lg">{song.title}</h1>
                <p className="text-xl opacity-90 mb-1">{song.artist}</p>
                <p className="text-sm opacity-75">{song.genre}</p>
              </div>
              
              <div className="mb-8 bg-black/30 backdrop-blur-sm rounded-2xl p-6 inline-block">
                <div className="text-sm opacity-75 mb-2">DIFFICULTY</div>
                <div className="text-3xl font-black uppercase">{difficulty}</div>
                <div className="text-sm opacity-75 mt-2">Level {song.difficulty[difficulty]}</div>
              </div>

              <button
                onClick={startGame}
                className="bg-white text-purple-900 px-16 py-5 rounded-full text-2xl font-black hover:scale-105 transition-transform shadow-2xl mb-4"
              >
                START
              </button>
              
              <button
                onClick={onBack}
                className="block mx-auto text-white/60 hover:text-white transition-colors"
              >
                ‚Üê Back to Songs
              </button>
            </div>
          </div>
        );
      }

      if (gameState === 'finished') {
        const totalNotes = beatmap.length;
        const hitNotes = judgments.perfect + judgments.great + judgments.good;
        const accuracy = totalNotes > 0 ? ((hitNotes / totalNotes) * 100).toFixed(1) : 0;
        const stars = calculateStars(accuracy);

        return (
          <div className="game-bg min-h-screen flex items-center justify-center text-white p-6">
            <div className="text-center max-w-lg">
              {/* Score Circle */}
              <div className="relative w-56 h-56 mx-auto mb-8">
                <svg className="w-full h-full transform -rotate-90">
                  <circle cx="112" cy="112" r="100" stroke="rgba(255,255,255,0.1)" strokeWidth="12" fill="rgba(0,0,0,0.5)" />
                  <circle cx="112" cy="112" r="100" stroke="url(#gradient)" strokeWidth="12" fill="none"
                    strokeDasharray={`${(accuracy / 100) * 628} 628`}
                    strokeLinecap="round" />
                  <defs>
                    <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" stopColor="#a855f7" />
                      <stop offset="100%" stopColor="#ec4899" />
                    </linearGradient>
                  </defs>
                </svg>
                <div className="absolute inset-0 flex flex-col items-center justify-center">
                  <div className="text-sm opacity-75 uppercase tracking-wider">Final Score</div>
                  <div className="text-5xl font-black my-2">{score.toLocaleString()}</div>
                  <div className="text-lg opacity-75">{accuracy}%</div>
                </div>
              </div>

              {/* Stars */}
              <div className="flex justify-center gap-2 mb-8">
                {[...Array(5)].map((_, i) => (
                  <Star key={i} className={`w-14 h-14 ${i < stars ? 'text-yellow-400' : 'text-gray-600'}`} filled={i < stars} />
                ))}
              </div>

              {/* Stats */}
              <div className="bg-black/30 backdrop-blur-sm rounded-2xl p-6 mb-6">
                <div className="grid grid-cols-4 gap-4 text-sm mb-4">
                  <div className="bg-green-500/20 rounded-xl p-3">
                    <div className="text-3xl font-bold text-green-400">{judgments.perfect}</div>
                    <div className="text-xs opacity-75 mt-1">PERFECT</div>
                  </div>
                  <div className="bg-cyan-500/20 rounded-xl p-3">
                    <div className="text-3xl font-bold text-cyan-400">{judgments.great}</div>
                    <div className="text-xs opacity-75 mt-1">GREAT</div>
                  </div>
                  <div className="bg-yellow-500/20 rounded-xl p-3">
                    <div className="text-3xl font-bold text-yellow-400">{judgments.good}</div>
                    <div className="text-xs opacity-75 mt-1">GOOD</div>
                  </div>
                  <div className="bg-red-500/20 rounded-xl p-3">
                    <div className="text-3xl font-bold text-red-400">{judgments.miss}</div>
                    <div className="text-xs opacity-75 mt-1">MISS</div>
                  </div>
                </div>
                <div className="text-sm opacity-75">Max Combo: <span className="font-bold">{maxCombo}</span></div>
              </div>
            </div>
          </div>
        );
      }

      // PLAYING
      const visibleNotes = notes.filter(note => {
        const position = (currentTime - note.time) * NOTE_SPEED + HIT_LINE;
        return position >= -0.15 && position <= 1.05 && !note.hit && !note.missed;
      });

      const progress = Math.min(100, (currentTime / (song.duration * 1000)) * 100);

      return (
        <div className="relative w-full h-screen game-bg overflow-hidden touch-none">
          {/* Top HUD */}
          <div className="absolute top-0 left-0 right-0 z-30 bg-gradient-to-b from-black/60 to-transparent p-4">
            <div className="flex items-center justify-between">
              {/* Score Circle */}
              <div className="relative w-24 h-24">
                <svg className="w-full h-full transform -rotate-90">
                  <circle cx="48" cy="48" r="42" stroke="rgba(255,255,255,0.2)" strokeWidth="5" fill="rgba(0,0,0,0.6)" />
                  <circle cx="48" cy="48" r="42" stroke="white" strokeWidth="5" fill="none"
                    strokeDasharray={`${(progress / 100) * 264} 264`}
                    strokeLinecap="round" />
                </svg>
                <div className="absolute inset-0 flex flex-col items-center justify-center text-white">
                  <div className="text-xs opacity-75">STAGE {difficulty === 'easy' ? '1' : difficulty === 'normal' ? '2' : '3'}</div>
                  <div className="text-xl font-black">{(score / 1000).toFixed(1)}K</div>
                  <div className="text-xs opacity-75">√ó{combo}</div>
                </div>
              </div>

              {/* Waveform */}
              <div className="flex-1 mx-6">
                <div className="waveform" />
              </div>

              {/* Pause */}
              <button
                onClick={onBack}
                className="w-12 h-12 rounded-full bg-black/60 backdrop-blur-sm flex items-center justify-center text-white hover:bg-black/80 transition-colors"
              >
                <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                </svg>
              </button>
            </div>
          </div>

          {/* Judgment Text */}
          {judgmentDisplay && (
            <div className="absolute top-1/3 left-0 right-0 z-40 flex justify-center pointer-events-none">
              <div className={`judgment-text text-6xl font-black ${judgmentDisplay.color} drop-shadow-2xl`}>
                {judgmentDisplay.text}
              </div>
            </div>
          )}

          {/* Game Field */}
          <div className="absolute inset-0 flex justify-center items-end pb-12">
            <div className="w-full max-w-2xl h-full relative">
              {/* Hit Panel */}
              <div
                className="absolute left-0 right-0 z-10 pointer-events-none bg-gradient-to-b from-white/5 via-white/15 to-white/5 border-y-2 border-white/30"
                style={{
                  top: `${HIT_PANEL_START * 100}%`,
                  height: `${(HIT_PANEL_END - HIT_PANEL_START) * 100}%`,
                  boxShadow: 'inset 0 2px 30px rgba(255,255,255,0.2), 0 0 40px rgba(255,255,255,0.1)'
                }}
              >
                <div className="absolute bottom-2 left-0 right-0 text-center text-white/10 text-xs font-bold tracking-[0.3em]">
                  P E R F E C T
                </div>
              </div>

              {/* Lane borders */}
              <div className="absolute inset-0 flex pointer-events-none z-5">
                {[...Array(LANES)].map((_, i) => (
                  <div key={i} className="flex-1 relative">
                    {i === 0 && <div className="absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-transparent via-white/40 to-transparent opacity-80" />}
                    {i === LANES - 1 && <div className="absolute right-0 top-0 bottom-0 w-1 bg-gradient-to-b from-transparent via-white/40 to-transparent opacity-80" />}
                    {i < LANES - 1 && <div className="absolute right-0 top-0 bottom-0 w-0.5 bg-white/15" />}
                  </div>
                ))}
              </div>

              {/* Interactive Lanes */}
              {[...Array(LANES)].map((_, lane) => (
                <div
                  key={lane}
                  className={`absolute top-0 bottom-0 z-20 ${laneFlashes[lane] ? 'lane-flash' : ''}`}
                  style={{
                    left: `${(lane / LANES) * 100}%`,
                    width: `${100 / LANES}%`
                  }}
                  onTouchStart={(e) => handleTouchStart(e, lane)}
                  onTouchEnd={(e) => handleTouchEnd(e, lane)}
                  onClick={() => checkHit(lane, null)}
                >
                  {/* Notes */}
                  {visibleNotes.filter(note => note.lane === lane).map(note => {
                    const position = ((currentTime - note.time) * NOTE_SPEED + HIT_LINE) * 100;
                    const isHold = note.type === NOTE_TYPES.HOLD;
                    const noteH = isHold ? NOTE_HEIGHT * 2.8 : NOTE_HEIGHT;

                    return (
                      <div
                        key={note.id}
                        className="absolute flex items-center justify-center pointer-events-none"
                        style={{
                          top: `${position}%`,
                          left: `${(1 - NOTE_WIDTH_RATIO) * 50}%`,
                          right: `${(1 - NOTE_WIDTH_RATIO) * 50}%`,
                          transform: 'translateY(-50%)',
                          height: `${noteH}px`
                        }}
                      >
                        {/* TAP */}
                        {note.type === NOTE_TYPES.TAP && (
                          <div className="w-full h-full rounded-2xl bg-gradient-to-b from-slate-600 via-slate-800 to-black border-3 border-white/70 shadow-2xl flex items-center justify-center"
                            style={{ boxShadow: '0 6px 30px rgba(0,0,0,0.8), inset 0 3px 20px rgba(255,255,255,0.15)' }}>
                            <div className="w-4/5 h-1.5 bg-white/90 rounded-full shadow-lg" />
                          </div>
                        )}

                        {/* HOLD */}
                        {isHold && (
                          <div className="w-full h-full rounded-2xl bg-gradient-to-b from-amber-400 via-orange-500 to-orange-700 border-3 border-amber-200 shadow-2xl flex flex-col items-center justify-around py-3"
                            style={{ boxShadow: '0 6px 30px rgba(251,191,36,0.7), inset 0 3px 20px rgba(255,255,255,0.2)' }}>
                            {[...Array(5)].map((_, i) => (
                              <div key={i} className="w-4/5 h-1.5 bg-white/95 rounded-full shadow-md" />
                            ))}
                          </div>
                        )}

                        {/* SWIPE UP */}
                        {note.type === NOTE_TYPES.SWIPE_UP && (
                          <div className="w-full h-full rounded-2xl bg-gradient-to-b from-slate-600 via-slate-800 to-black border-3 border-cyan-300 flex items-center justify-center shadow-2xl"
                            style={{ boxShadow: '0 6px 30px rgba(34,211,238,0.7), inset 0 3px 20px rgba(34,211,238,0.25)' }}>
                            <svg className="w-20 h-20 text-white drop-shadow-2xl" fill="currentColor" viewBox="0 0 24 24">
                              <path d="M12 3l-10 10h6v8h8v-8h6z" />
                            </svg>
                          </div>
                        )}

                        {/* SWIPE LEFT */}
                        {note.type === NOTE_TYPES.SWIPE_LEFT && (
                          <div className="w-full h-full rounded-2xl bg-gradient-to-b from-slate-600 via-slate-800 to-black border-3 border-red-300 flex items-center justify-center shadow-2xl"
                            style={{ boxShadow: '0 6px 30px rgba(248,113,113,0.7), inset 0 3px 20px rgba(248,113,113,0.25)' }}>
                            <svg className="w-20 h-20 text-white drop-shadow-2xl" fill="currentColor" viewBox="0 0 24 24" transform="rotate(90)">
                              <path d="M12 3l-10 10h6v8h8v-8h6z" />
                            </svg>
                          </div>
                        )}

                        {/* SWIPE RIGHT */}
                        {note.type === NOTE_TYPES.SWIPE_RIGHT && (
                          <div className="w-full h-full rounded-2xl bg-gradient-to-b from-slate-600 via-slate-800 to-black border-3 border-purple-300 flex items-center justify-center shadow-2xl"
                            style={{ boxShadow: '0 6px 30px rgba(192,132,252,0.7), inset 0 3px 20px rgba(192,132,252,0.25)' }}>
                            <svg className="w-20 h-20 text-white drop-shadow-2xl" fill="currentColor" viewBox="0 0 24 24" transform="rotate(270)">
                              <path d="M12 3l-10 10h6v8h8v-8h6z" />
                            </svg>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<BeatstarClone />);
  </script>
</body>
</html>
