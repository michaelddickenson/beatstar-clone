<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <title>Beatstar Clone</title>
  <link rel="manifest" href="manifest.json">
  
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      user-select: none;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
      overscroll-behavior: none;
      position: fixed;
      width: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    
    #root {
      width: 100%;
      height: 100%;
      overflow: auto;
    }

    /* Animated gradient backgrounds */
    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .game-bg-purple {
      background: linear-gradient(45deg, #4a148c, #6a1b9a, #8e24aa, #ab47bc);
      background-size: 400% 400%;
      animation: gradientShift 8s ease infinite;
    }

    .game-bg-orange {
      background: linear-gradient(45deg, #e65100, #f57c00, #fb8c00, #ffa726);
      background-size: 400% 400%;
      animation: gradientShift 8s ease infinite;
    }

    .game-bg-yellow {
      background: linear-gradient(45deg, #f57f17, #f9a825, #fbc02d, #fdd835);
      background-size: 400% 400%;
      animation: gradientShift 8s ease infinite;
    }

    /* Lane flash effect */
    @keyframes laneFlash {
      0% { background-color: rgba(255, 255, 255, 0.3); }
      100% { background-color: transparent; }
    }

    .lane-flash {
      animation: laneFlash 0.2s ease-out;
    }

    /* Judgment text animation */
    @keyframes judgmentPop {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 0; }
    }

    .judgment-text {
      animation: judgmentPop 0.5s ease-out;
    }
  </style>
  
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    
    // Inline SVG icons
    const Plus = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>;
    const Star = ({className = "w-5 h-5"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>;
    const Lock = ({className = "w-4 h-4"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>;
    const Music = ({className = "w-8 h-8"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" /></svg>;
    const Award = ({className = "w-5 h-5"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" /></svg>;
    const Trash = ({className = "w-5 h-5"}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;

    // CORRECTED SETTINGS - Much slower, realistic Beatstar
    const LANES = 3;
    const HIT_LINE_POSITION = 0.85; // Much lower, like real Beatstar
    const NOTE_SPEED = 0.0006; // 5x SLOWER than before!
    const NOTE_HEIGHT = 80; // Taller tiles
    const TIMING_WINDOWS = { 
      perfect: 75,  // More forgiving
      great: 120, 
      good: 180, 
      miss: 250 
    };
    const NOTE_TYPES = { TAP: 'tap', HOLD: 'hold', SWIPE_LEFT: 'swipe-left', SWIPE_RIGHT: 'swipe-right', SWIPE_UP: 'swipe-up' };

    const INITIAL_PLAYER = {
      id: 'player1', name: 'Player', currency: 100, totalStars: 0,
      unlockedSongs: ['song-1', 'song-2', 'song-3'],
      completedChallenges: [], scores: {}, wishlist: [], unlockedGiftBoxes: []
    };

    const INITIAL_SONGS = [
      { id: 'song-1', title: 'Starter Beat', artist: 'Tutorial', genre: 'Electronic', unlockTier: 0, bpm: 120, duration: 90, difficulty: { easy: 1, normal: 3, hard: 5 }, audioUrl: null },
      { id: 'song-2', title: 'Rhythm Flow', artist: 'Beginner', genre: 'Pop', unlockTier: 0, bpm: 110, duration: 90, difficulty: { easy: 2, normal: 4, hard: 6 }, audioUrl: null },
      { id: 'song-3', title: 'Beat Drop', artist: 'Starter', genre: 'Electronic', unlockTier: 0, bpm: 128, duration: 90, difficulty: { easy: 1, normal: 3, hard: 5 }, audioUrl: null }
    ];

    const generateBeatmap = (bpm, duration, difficulty) => {
      const notes = [];
      const beatInterval = (60 / bpm) * 1000;
      const noteDensity = { easy: 0.4, normal: 0.6, hard: 0.8 }[difficulty] || 0.6;
      let time = 3000; // Start after 3 seconds
      const endTime = duration * 1000 - 2000;

      while (time < endTime) {
        const lane = Math.floor(Math.random() * LANES);
        const noteTypeRoll = Math.random();
        let noteType = NOTE_TYPES.TAP;
        
        if (difficulty === 'hard') {
          if (noteTypeRoll < 0.12) noteType = NOTE_TYPES.HOLD;
          else if (noteTypeRoll < 0.22) noteType = NOTE_TYPES.SWIPE_LEFT;
          else if (noteTypeRoll < 0.32) noteType = NOTE_TYPES.SWIPE_RIGHT;
          else if (noteTypeRoll < 0.40) noteType = NOTE_TYPES.SWIPE_UP;
        } else if (difficulty === 'normal') {
          if (noteTypeRoll < 0.08) noteType = NOTE_TYPES.HOLD;
          else if (noteTypeRoll < 0.12) noteType = NOTE_TYPES.SWIPE_UP;
        }

        notes.push({ 
          id: `note-${time}-${lane}`, 
          lane, 
          time, 
          type: noteType, 
          duration: noteType === NOTE_TYPES.HOLD ? beatInterval * 2 : 0 
        });
        
        time += beatInterval / noteDensity;
      }
      return notes;
    };

    const calculateStars = (accuracy) => {
      if (accuracy >= 98) return 5;
      if (accuracy >= 95) return 4;
      if (accuracy >= 90) return 3;
      if (accuracy >= 80) return 2;
      if (accuracy >= 60) return 1;
      return 0;
    };

    const calculateCurrency = (stars, difficulty) => {
      const baseReward = { easy: 10, normal: 20, hard: 30 }[difficulty] || 10;
      return baseReward * stars;
    };

    function BeatstarClone() {
      const [currentScreen, setCurrentScreen] = useState('home');
      const [player, setPlayer] = useState(() => {
        const saved = localStorage.getItem('beatstar-player');
        return saved ? JSON.parse(saved) : INITIAL_PLAYER;
      });
      const [songs, setSongs] = useState(() => {
        const saved = localStorage.getItem('beatstar-songs');
        return saved ? JSON.parse(saved) : INITIAL_SONGS;
      });
      const [selectedSong, setSelectedSong] = useState(null);
      const [selectedDifficulty, setSelectedDifficulty] = useState('normal');
      const [showUnlockChoice, setShowUnlockChoice] = useState(false);
      const [unlockOptions, setUnlockOptions] = useState([]);

      useEffect(() => { localStorage.setItem('beatstar-player', JSON.stringify(player)); }, [player]);
      useEffect(() => { localStorage.setItem('beatstar-songs', JSON.stringify(songs)); }, [songs]);

      const isSongUnlocked = (song) => player.unlockedSongs.includes(song.id);
      const canUnlockSong = (song) => !song.requiredStars || player.totalStars >= song.requiredStars;
      const unlockSong = (songId) => setPlayer(prev => ({ ...prev, unlockedSongs: [...prev.unlockedSongs, songId] }));

      const handleUnlockWithChoice = () => {
        const lockedSongs = songs.filter(s => !isSongUnlocked(s) && canUnlockSong(s));
        if (lockedSongs.length === 0) { alert('No songs available!'); return; }
        const wishlistSongs = lockedSongs.filter(s => player.wishlist.includes(s.id));
        const otherSongs = lockedSongs.filter(s => !player.wishlist.includes(s.id));
        const options = [];
        options.push(...wishlistSongs.slice(0, 2));
        const shuffled = [...otherSongs].sort(() => Math.random() - 0.5);
        options.push(...shuffled.slice(0, 3 - options.length));
        setUnlockOptions(options);
        setShowUnlockChoice(true);
      };

      const confirmUnlock = (songId) => { unlockSong(songId); setShowUnlockChoice(false); };
      const toggleWishlist = (songId) => setPlayer(prev => ({ ...prev, wishlist: prev.wishlist.includes(songId) ? prev.wishlist.filter(id => id !== songId) : [...prev.wishlist, songId] }));
      const startGame = (song, difficulty) => { setSelectedSong(song); setSelectedDifficulty(difficulty); setCurrentScreen('game'); };

      const endGame = (score, accuracy, perfect, great, good, miss) => {
        const stars = calculateStars(accuracy);
        const currencyEarned = calculateCurrency(stars, selectedDifficulty);
        const scoreKey = `${selectedSong.id}-${selectedDifficulty}`;
        const previousBest = player.scores[scoreKey];
        const isNewBest = !previousBest || score > previousBest.score;

        setPlayer(prev => {
          const newScores = { ...prev.scores };
          if (isNewBest) newScores[scoreKey] = { score, stars, accuracy, perfect, great, good, miss };
          const newTotalStars = Object.values(newScores).reduce((sum, s) => sum + s.stars, 0);
          return { ...prev, scores: newScores, totalStars: newTotalStars, currency: prev.currency + currencyEarned };
        });
        setCurrentScreen('home');
      };

      const addSong = (newSong) => setSongs(prev => [...prev, { ...newSong, id: `song-${Date.now()}` }]);
      const deleteSong = (songId) => { if (confirm('Delete?')) setSongs(prev => prev.filter(s => s.id !== songId)); };

      if (currentScreen === 'game' && selectedSong) return <GameScreen song={selectedSong} difficulty={selectedDifficulty} onEnd={endGame} onBack={() => setCurrentScreen('home')} />;
      if (currentScreen === 'admin') return <AdminPanel songs={songs} onAddSong={addSong} onDeleteSong={deleteSong} onBack={() => setCurrentScreen('home')} />;

      return (
        <div className="min-h-screen bg-gradient-to-br from-purple-900 via-black to-blue-900 text-white">
          <div className="bg-black/40 backdrop-blur-sm border-b border-purple-500/30 p-4">
            <div className="flex justify-between items-center max-w-6xl mx-auto">
              <div>
                <h1 className="text-3xl font-black tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">BEATSTAR</h1>
                <p className="text-sm text-purple-300">{player.name}</p>
              </div>
              <div className="flex gap-4 items-center">
                <div className="flex items-center gap-2 bg-yellow-500/20 px-4 py-2 rounded-full border border-yellow-400/30">
                  <Award /><span className="font-bold text-yellow-300">{player.currency}</span>
                </div>
                <div className="flex items-center gap-2 bg-purple-500/20 px-4 py-2 rounded-full border border-purple-400/30">
                  <Star /><span className="font-bold text-purple-300">{player.totalStars}</span>
                </div>
              </div>
            </div>
          </div>

          <div className="bg-black/30 border-b border-purple-500/20 p-3">
            <div className="flex gap-3 max-w-6xl mx-auto">
              <button onClick={() => setCurrentScreen('home')} className={`px-6 py-2 rounded-lg font-bold ${currentScreen === 'home' ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-white/5 text-purple-300'}`}>Songs</button>
              <button onClick={() => setCurrentScreen('admin')} className={`px-6 py-2 rounded-lg font-bold ${currentScreen === 'admin' ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-white/5 text-purple-300'}`}>Admin</button>
            </div>
          </div>

          <div className="p-6 max-w-6xl mx-auto">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-black text-purple-300">Your Songs</h2>
              <button onClick={handleUnlockWithChoice} className="flex items-center gap-2 bg-gradient-to-r from-green-500 to-emerald-500 px-4 py-2 rounded-lg font-bold">
                <Plus />Unlock Song
              </button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {songs.map(song => {
                const unlocked = isSongUnlocked(song);
                return (
                  <div key={song.id} className={`relative bg-gradient-to-br from-purple-900/50 to-blue-900/50 rounded-xl p-5 border-2 ${unlocked ? 'border-purple-500/50' : 'border-gray-700/50 opacity-60'}`}>
                    {!unlocked && <div className="absolute top-3 right-3 bg-red-500/80 p-2 rounded-full"><Lock /></div>}
                    <div className="flex items-center gap-3 mb-3">
                      <div className="w-16 h-16 rounded-lg bg-gradient-to-br from-pink-500 to-purple-600 flex items-center justify-center"><Music /></div>
                      <div className="flex-1">
                        <h3 className="font-bold text-lg">{unlocked ? song.title : '???'}</h3>
                        <p className="text-sm text-purple-300">{unlocked ? song.artist : 'Locked'}</p>
                      </div>
                    </div>
                    {unlocked && (
                      <>
                        <div className="flex gap-2 mb-3">
                          <span className="text-xs px-2 py-1 bg-purple-500/30 rounded">{song.genre}</span>
                          <span className="text-xs px-2 py-1 bg-blue-500/30 rounded">{song.bpm} BPM</span>
                        </div>
                        <div className="grid grid-cols-3 gap-2">
                          {['easy', 'normal', 'hard'].map(diff => {
                            const scoreKey = `${song.id}-${diff}`;
                            const score = player.scores[scoreKey];
                            return (
                              <button key={diff} onClick={() => startGame(song, diff)} className="bg-black/40 p-2 rounded-lg hover:bg-black/60 text-left">
                                <div className="text-xs font-bold uppercase text-purple-300">{diff}</div>
                                <div className="text-xs text-gray-400">Lvl {song.difficulty[diff]}</div>
                                {score && <div className="flex items-center gap-1 mt-1">{[...Array(score.stars)].map((_, i) => <Star key={i} className="w-3 h-3 fill-yellow-400 text-yellow-400" />)}</div>}
                              </button>
                            );
                          })}
                        </div>
                      </>
                    )}
                    <button onClick={(e) => { e.stopPropagation(); toggleWishlist(song.id); }} className={`absolute bottom-3 right-3 p-2 rounded-full ${player.wishlist.includes(song.id) ? 'bg-pink-500' : 'bg-white/10 text-gray-400'}`}>
                      <Star className="w-4 h-4" />
                    </button>
                  </div>
                );
              })}
            </div>
          </div>

          {showUnlockChoice && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
              <div className="bg-gradient-to-br from-purple-900 to-blue-900 rounded-2xl p-8 max-w-4xl w-full border-2 border-purple-500">
                <h2 className="text-3xl font-black mb-6 text-center text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">Choose Your Next Song</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                  {unlockOptions.map(song => (
                    <div key={song.id} onClick={() => confirmUnlock(song.id)} className="bg-black/40 rounded-xl p-5 border-2 border-purple-500/50 hover:border-pink-500 cursor-pointer">
                      <div className="w-20 h-20 rounded-lg bg-gradient-to-br from-pink-500 to-purple-600 flex items-center justify-center mx-auto mb-3"><Music /></div>
                      <h3 className="font-bold text-center mb-1">{song.title}</h3>
                      <p className="text-sm text-purple-300 text-center">{song.artist}</p>
                      {player.wishlist.includes(song.id) && <div className="text-center mt-2 text-pink-400 text-xs font-bold">⭐ WISHLIST</div>}
                    </div>
                  ))}
                </div>
                <button onClick={() => setShowUnlockChoice(false)} className="w-full bg-gray-700 py-3 rounded-lg font-bold">Cancel</button>
              </div>
            </div>
          )}
        </div>
      );
    }

    function GameScreen({ song, difficulty, onEnd, onBack }) {
      const [gameState, setGameState] = useState('ready');
      const [score, setScore] = useState(0);
      const [combo, setCombo] = useState(0);
      const [maxCombo, setMaxCombo] = useState(0);
      const [judgments, setJudgments] = useState({ perfect: 0, great: 0, good: 0, miss: 0 });
      const [notes, setNotes] = useState([]);
      const [currentTime, setCurrentTime] = useState(0);
      const [beatmap, setBeatmap] = useState(null);
      const [touchStart, setTouchStart] = useState({});
      const [laneFlashes, setLaneFlashes] = useState([false, false, false]);
      const [judgmentDisplay, setJudgmentDisplay] = useState(null);
      const gameLoopRef = useRef(null);
      const startTimeRef = useRef(null);
      const audioRef = useRef(null);

      useEffect(() => {
        const map = generateBeatmap(song.bpm, song.duration, difficulty);
        setBeatmap(map);
        setNotes(map.map(n => ({ ...n, hit: false, missed: false })));
      }, [song, difficulty]);

      const startGame = () => {
        setGameState('playing');
        startTimeRef.current = Date.now();
        if (song.audioUrl) { 
          audioRef.current = new Audio(song.audioUrl); 
          audioRef.current.play(); 
        }
        gameLoopRef.current = setInterval(() => {
          const elapsed = Date.now() - startTimeRef.current;
          setCurrentTime(elapsed);
          setNotes(prev => prev.map(note => {
            if (!note.hit && !note.missed && elapsed > note.time + TIMING_WINDOWS.miss) {
              setCombo(0);
              setJudgments(j => ({ ...j, miss: j.miss + 1 }));
              showJudgment('MISS', 'text-red-500');
              return { ...note, missed: true };
            }
            return note;
          }));
          if (elapsed > song.duration * 1000) endGameNow();
        }, 16);
      };

      const endGameNow = () => {
        clearInterval(gameLoopRef.current);
        if (audioRef.current) { audioRef.current.pause(); audioRef.current = null; }
        setGameState('finished');
        const totalNotes = beatmap.length;
        const hitNotes = judgments.perfect + judgments.great + judgments.good;
        const accuracy = totalNotes > 0 ? (hitNotes / totalNotes) * 100 : 0;
        setTimeout(() => { onEnd(score, accuracy, judgments.perfect, judgments.great, judgments.good, judgments.miss); }, 2000);
      };

      const flashLane = (lane) => {
        setLaneFlashes(prev => { const n = [...prev]; n[lane] = true; return n; });
        setTimeout(() => setLaneFlashes(prev => { const n = [...prev]; n[lane] = false; return n; }), 200);
      };

      const showJudgment = (text, color) => {
        setJudgmentDisplay({ text, color });
        setTimeout(() => setJudgmentDisplay(null), 500);
      };

      const handleTouchStart = (e, lane) => {
        e.preventDefault();
        const touch = e.touches[0];
        setTouchStart({ x: touch.clientX, y: touch.clientY, lane, time: Date.now() });
        checkHit(lane, null);
      };

      const handleTouchEnd = (e, lane) => {
        e.preventDefault();
        if (!touchStart.lane) return;
        const touch = e.changedTouches[0];
        const dx = touch.clientX - touchStart.x;
        const dy = touch.clientY - touchStart.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        if (distance > 50) {
          const angle = Math.atan2(dy, dx) * (180 / Math.PI);
          let swipeType = null;
          if (angle > -45 && angle < 45) swipeType = NOTE_TYPES.SWIPE_RIGHT;
          else if (angle < -45 && angle > -135) swipeType = NOTE_TYPES.SWIPE_UP;
          else swipeType = NOTE_TYPES.SWIPE_LEFT;
          if (swipeType) checkHit(lane, swipeType);
        }
        setTouchStart({});
      };

      const checkHit = (lane, swipeType) => {
        const hitTime = currentTime;
        let bestNote = null;
        let bestTiming = Infinity;
        
        notes.forEach(note => {
          if (note.lane === lane && !note.hit && !note.missed) {
            const timing = Math.abs(note.time - hitTime);
            if (timing < TIMING_WINDOWS.miss && timing < bestTiming) {
              if (swipeType && note.type !== swipeType && note.type !== NOTE_TYPES.TAP) return;
              if (!swipeType && note.type !== NOTE_TYPES.TAP && note.type !== NOTE_TYPES.HOLD) return;
              bestNote = note; 
              bestTiming = timing;
            }
          }
        });

        if (bestNote) {
          let judgment = 'miss', points = 0, judgmentText = 'MISS', judgmentColor = 'text-red-500';
          
          if (bestTiming < TIMING_WINDOWS.perfect) {
            judgment = 'perfect';
            points = 100;
            judgmentText = 'PERFECT+';
            judgmentColor = 'text-cyan-400';
          } else if (bestTiming < TIMING_WINDOWS.great) {
            judgment = 'great';
            points = 75;
            judgmentText = 'GREAT';
            judgmentColor = 'text-green-400';
          } else if (bestTiming < TIMING_WINDOWS.good) {
            judgment = 'good';
            points = 50;
            judgmentText = 'GOOD';
            judgmentColor = 'text-yellow-400';
          }

          if (judgment !== 'miss') {
            setNotes(prev => prev.map(n => n.id === bestNote.id ? { ...n, hit: true } : n));
            setScore(s => s + points * (combo + 1));
            setCombo(c => {
              const newCombo = c + 1;
              setMaxCombo(max => Math.max(max, newCombo));
              return newCombo;
            });
            setJudgments(j => ({ ...j, [judgment]: j[judgment] + 1 }));
            flashLane(lane);
            showJudgment(judgmentText, judgmentColor);
          } else {
            setCombo(0);
            showJudgment(judgmentText, judgmentColor);
          }
        }
      };

      if (gameState === 'ready') {
        const bgColor = difficulty === 'easy' ? 'game-bg-yellow' : difficulty === 'normal' ? 'game-bg-orange' : 'game-bg-purple';
        return (
          <div className={`min-h-screen ${bgColor} flex items-center justify-center text-white`}>
            <div className="text-center">
              <h1 className="text-4xl font-black mb-4 drop-shadow-lg">{song.title}</h1>
              <p className="text-xl mb-2 opacity-90">{song.artist}</p>
              <p className="text-lg opacity-75 mb-8">{difficulty.toUpperCase()} - Level {song.difficulty[difficulty]}</p>
              <button onClick={startGame} className="bg-white text-black px-12 py-4 rounded-full text-2xl font-black hover:scale-105 transition-transform shadow-2xl">
                START
              </button>
              <button onClick={onBack} className="block mx-auto mt-4 opacity-75 hover:opacity-100 transition-opacity">
                ← Back
              </button>
            </div>
          </div>
        );
      }

      if (gameState === 'finished') {
        const totalNotes = beatmap.length;
        const hitNotes = judgments.perfect + judgments.great + judgments.good;
        const accuracy = totalNotes > 0 ? ((hitNotes / totalNotes) * 100).toFixed(1) : 0;
        const stars = calculateStars(accuracy);
        const bgColor = difficulty === 'easy' ? 'game-bg-yellow' : difficulty === 'normal' ? 'game-bg-orange' : 'game-bg-purple';
        
        return (
          <div className={`min-h-screen ${bgColor} flex items-center justify-center text-white p-6`}>
            <div className="text-center max-w-md">
              {/* Score Circle like Beatstar */}
              <div className="relative w-48 h-48 mx-auto mb-8">
                <svg className="w-full h-full transform -rotate-90">
                  <circle cx="96" cy="96" r="88" stroke="rgba(255,255,255,0.2)" strokeWidth="8" fill="none" />
                  <circle cx="96" cy="96" r="88" stroke="white" strokeWidth="8" fill="none" 
                    strokeDasharray={`${(accuracy / 100) * 553} 553`}
                    strokeLinecap="round" />
                </svg>
                <div className="absolute inset-0 flex flex-col items-center justify-center">
                  <div className="text-sm opacity-75">FINAL STAGE</div>
                  <div className="text-4xl font-black">{score.toLocaleString()}</div>
                  <div className="text-sm opacity-75">:{stars}</div>
                </div>
              </div>

              <div className="flex justify-center gap-2 mb-6">
                {[...Array(5)].map((_, i) => (
                  <Star key={i} className={`w-10 h-10 ${i < stars ? 'fill-yellow-400 text-yellow-400' : 'fill-none text-white opacity-30'}`} />
                ))}
              </div>

              <div className="bg-black/40 rounded-2xl p-6 backdrop-blur-sm">
                <div className="text-xl mb-4">Accuracy: {accuracy}%</div>
                <div className="grid grid-cols-4 gap-3 text-sm">
                  <div className="bg-cyan-500/20 rounded-lg p-3">
                    <div className="text-2xl font-bold text-cyan-400">{judgments.perfect}</div>
                    <div className="text-xs opacity-75">PERFECT</div>
                  </div>
                  <div className="bg-green-500/20 rounded-lg p-3">
                    <div className="text-2xl font-bold text-green-400">{judgments.great}</div>
                    <div className="text-xs opacity-75">GREAT</div>
                  </div>
                  <div className="bg-yellow-500/20 rounded-lg p-3">
                    <div className="text-2xl font-bold text-yellow-400">{judgments.good}</div>
                    <div className="text-xs opacity-75">GOOD</div>
                  </div>
                  <div className="bg-red-500/20 rounded-lg p-3">
                    <div className="text-2xl font-bold text-red-400">{judgments.miss}</div>
                    <div className="text-xs opacity-75">MISS</div>
                  </div>
                </div>
                <div className="mt-4 text-sm opacity-75">Max Combo: {maxCombo}</div>
              </div>
            </div>
          </div>
        );
      }

      // PLAYING STATE - Real Beatstar UI
      const visibleNotes = notes.filter(note => {
        const position = (currentTime - note.time) * NOTE_SPEED + HIT_LINE_POSITION;
        return position >= -0.1 && position <= 1.1 && !note.hit && !note.missed;
      });

      const bgColor = difficulty === 'easy' ? 'game-bg-yellow' : difficulty === 'normal' ? 'game-bg-orange' : 'game-bg-purple';
      const progress = (currentTime / (song.duration * 1000)) * 100;

      return (
        <div className={`relative w-full h-screen ${bgColor} overflow-hidden touch-none`}>
          {/* Top Score Circle - Like Beatstar */}
          <div className="absolute top-4 left-0 right-0 z-30 flex justify-center">
            <div className="relative w-32 h-32">
              <svg className="w-full h-full transform -rotate-90">
                <circle cx="64" cy="64" r="58" stroke="rgba(255,255,255,0.3)" strokeWidth="4" fill="rgba(0,0,0,0.6)" />
                <circle cx="64" cy="64" r="58" stroke="white" strokeWidth="4" fill="none" 
                  strokeDasharray={`${(progress / 100) * 365} 365`}
                  strokeLinecap="round" />
              </svg>
              <div className="absolute inset-0 flex flex-col items-center justify-center text-white">
                <div className="text-xs opacity-75">STAGE {difficulty === 'easy' ? '1' : difficulty === 'normal' ? '2' : '3'}</div>
                <div className="text-2xl font-black">{score.toLocaleString()}</div>
                <div className="text-xs opacity-75">:{combo}</div>
              </div>
            </div>
          </div>

          {/* Judgment Display */}
          {judgmentDisplay && (
            <div className="absolute top-1/3 left-0 right-0 z-40 flex justify-center pointer-events-none">
              <div className={`judgment-text text-5xl font-black ${judgmentDisplay.color} drop-shadow-2xl`}>
                {judgmentDisplay.text}
              </div>
            </div>
          )}

          {/* Game Area with Lanes */}
          <div className="absolute inset-0 flex items-end" style={{ paddingBottom: '8%' }}>
            <div className="w-full h-full flex relative">
              {/* Lane borders and decorations */}
              <div className="absolute inset-0 flex pointer-events-none">
                {[...Array(LANES)].map((_, i) => (
                  <div key={i} className="flex-1 relative">
                    {/* Decorative side borders like Beatstar */}
                    {i === 0 && <div className="absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-transparent via-white/50 to-transparent" />}
                    {i === LANES - 1 && <div className="absolute right-0 top-0 bottom-0 w-1 bg-gradient-to-b from-transparent via-white/50 to-transparent" />}
                    {/* Inner lane separators */}
                    {i < LANES - 1 && <div className="absolute right-0 top-0 bottom-0 w-0.5 bg-white/20" />}
                  </div>
                ))}
              </div>

              {/* Interactive Lanes */}
              {[...Array(LANES)].map((_, lane) => (
                <div
                  key={lane}
                  className={`flex-1 relative ${laneFlashes[lane] ? 'lane-flash' : ''}`}
                  onTouchStart={(e) => handleTouchStart(e, lane)}
                  onTouchEnd={(e) => handleTouchEnd(e, lane)}
                  onClick={() => checkHit(lane, null)}
                >
                  {/* Hit Line - Much thicker and more visible */}
                  <div 
                    className="absolute left-0 right-0 h-1.5 z-10 pointer-events-none"
                    style={{ 
                      top: `${HIT_LINE_POSITION * 100}%`,
                      background: 'linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,1) 50%, rgba(255,255,255,0) 100%)',
                      boxShadow: '0 0 20px rgba(255,255,255,0.8)'
                    }}
                  />

                  {/* Notes */}
                  {visibleNotes.filter(note => note.lane === lane).map(note => {
                    const position = ((currentTime - note.time) * NOTE_SPEED + HIT_LINE_POSITION) * 100;
                    
                    return (
                      <div
                        key={note.id}
                        className="absolute left-1 right-1 flex items-center justify-center pointer-events-none"
                        style={{ 
                          top: `${position}%`, 
                          transform: 'translateY(-50%)',
                          height: `${NOTE_HEIGHT}px`
                        }}
                      >
                        {note.type === NOTE_TYPES.TAP && (
                          <div className="w-full h-full rounded-lg bg-gradient-to-b from-gray-800 to-black border-2 border-white/80 shadow-2xl" 
                            style={{ boxShadow: '0 4px 20px rgba(0,0,0,0.5), inset 0 2px 10px rgba(255,255,255,0.3)' }} />
                        )}
                        {note.type === NOTE_TYPES.HOLD && (
                          <div className="w-full rounded-lg bg-gradient-to-b from-yellow-600 to-orange-700 border-2 border-yellow-300 shadow-2xl" 
                            style={{ height: `${NOTE_HEIGHT * 2}px`, boxShadow: '0 4px 20px rgba(251,191,36,0.5)' }} />
                        )}
                        {note.type === NOTE_TYPES.SWIPE_UP && (
                          <div className="w-full h-full rounded-lg bg-gradient-to-b from-gray-800 to-black border-2 border-cyan-400 flex items-center justify-center shadow-2xl"
                            style={{ boxShadow: '0 4px 20px rgba(34,211,238,0.5)' }}>
                            <div className="text-5xl font-black text-white drop-shadow-lg">↑</div>
                          </div>
                        )}
                        {note.type === NOTE_TYPES.SWIPE_LEFT && (
                          <div className="w-full h-full rounded-lg bg-gradient-to-b from-gray-800 to-black border-2 border-red-400 flex items-center justify-center shadow-2xl"
                            style={{ boxShadow: '0 4px 20px rgba(248,113,113,0.5)' }}>
                            <div className="text-5xl font-black text-white drop-shadow-lg">←</div>
                          </div>
                        )}
                        {note.type === NOTE_TYPES.SWIPE_RIGHT && (
                          <div className="w-full h-full rounded-lg bg-gradient-to-b from-gray-800 to-black border-2 border-purple-400 flex items-center justify-center shadow-2xl"
                            style={{ boxShadow: '0 4px 20px rgba(192,132,252,0.5)' }}>
                            <div className="text-5xl font-black text-white drop-shadow-lg">→</div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              ))}
            </div>
          </div>

          {/* Exit button */}
          <button 
            onClick={onBack}
            className="absolute top-4 right-4 z-30 bg-black/60 text-white px-4 py-2 rounded-lg font-bold backdrop-blur-sm hover:bg-black/80 transition-all"
          >
            Exit
          </button>
        </div>
      );
    }

    function AdminPanel({ songs, onAddSong, onDeleteSong, onBack }) {
      const [newSong, setNewSong] = useState({ title: '', artist: '', genre: '', bpm: 120, duration: 180, unlockTier: 0, requiredStars: 0, audioUrl: '' });

      const handleAddSong = () => {
        if (!newSong.title || !newSong.artist) { alert('Fill in title and artist'); return; }
        const song = { ...newSong, difficulty: { easy: Math.floor(Math.random() * 3) + 1, normal: Math.floor(Math.random() * 3) + 3, hard: Math.floor(Math.random() * 3) + 5 } };
        onAddSong(song);
        setNewSong({ title: '', artist: '', genre: '', bpm: 120, duration: 180, unlockTier: 0, requiredStars: 0, audioUrl: '' });
        alert('Song added!');
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-purple-900 via-black to-blue-900 text-white p-6">
          <div className="max-w-6xl mx-auto">
            <button onClick={onBack} className="mb-6 px-4 py-2 bg-purple-600 rounded-lg">← Back</button>
            <h1 className="text-4xl font-black mb-8 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">Admin Panel</h1>
            <div className="bg-gradient-to-br from-purple-900/50 to-blue-900/50 rounded-xl p-6 border-2 border-purple-500/50 mb-8">
              <h2 className="text-2xl font-bold mb-4">Add New Song</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <input type="text" placeholder="Title" value={newSong.title} onChange={(e) => setNewSong({ ...newSong, title: e.target.value })} className="bg-black/40 border border-purple-500/30 rounded-lg px-4 py-2 text-white" />
                <input type="text" placeholder="Artist" value={newSong.artist} onChange={(e) => setNewSong({ ...newSong, artist: e.target.value })} className="bg-black/40 border border-purple-500/30 rounded-lg px-4 py-2 text-white" />
                <input type="text" placeholder="Genre" value={newSong.genre} onChange={(e) => setNewSong({ ...newSong, genre: e.target.value })} className="bg-black/40 border border-purple-500/30 rounded-lg px-4 py-2 text-white" />
                <input type="number" placeholder="BPM" value={newSong.bpm} onChange={(e) => setNewSong({ ...newSong, bpm: parseInt(e.target.value) })} className="bg-black/40 border border-purple-500/30 rounded-lg px-4 py-2 text-white" />
                <input type="number" placeholder="Duration (sec)" value={newSong.duration} onChange={(e) => setNewSong({ ...newSong, duration: parseInt(e.target.value) })} className="bg-black/40 border border-purple-500/30 rounded-lg px-4 py-2 text-white" />
                <input type="number" placeholder="Unlock Tier" value={newSong.unlockTier} onChange={(e) => setNewSong({ ...newSong, unlockTier: parseInt(e.target.value) })} className="bg-black/40 border border-purple-500/30 rounded-lg px-4 py-2 text-white" />
                <input type="text" placeholder="Audio URL: ./songs/song.mp3" value={newSong.audioUrl} onChange={(e) => setNewSong({ ...newSong, audioUrl: e.target.value })} className="bg-black/40 border border-purple-500/30 rounded-lg px-4 py-2 text-white col-span-2" />
              </div>
              <button onClick={handleAddSong} className="w-full bg-gradient-to-r from-purple-500 to-pink-500 py-3 rounded-lg font-bold">Add Song</button>
            </div>
            <div className="bg-gradient-to-br from-purple-900/50 to-blue-900/50 rounded-xl p-6 border-2 border-purple-500/50">
              <h2 className="text-2xl font-bold mb-4">All Songs ({songs.length})</h2>
              <div className="space-y-3">
                {songs.map(song => (
                  <div key={song.id} className="bg-black/40 rounded-lg p-4 flex justify-between items-center">
                    <div>
                      <h3 className="font-bold">{song.title}</h3>
                      <p className="text-sm text-gray-400">{song.artist} • {song.genre} • {song.bpm} BPM • {song.duration}s</p>
                    </div>
                    <button onClick={() => onDeleteSong(song.id)} className="bg-red-500/20 p-2 rounded-lg text-red-400"><Trash /></button>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<BeatstarClone />);
  </script>
</body>
</html>
